{% extends 'todo/index.html' %}

{% block title %} {{title}} {% endblock %}

{% block content %}
  <!-- Блок предуприждения о работе js -->
  {% block  alert %}
    <div class="content">    
      <div id="test_working_js" class="alert alert-warning" role="alert">
        Включите javascript для корректной работы сайта
      </div>
    </div>
  {% endblock %}

  {% block modal_append_comment %}
    {% include 'todo/modal_append_comment.html' %}
  {% endblock %}

  {% block modal_append_task %}
    {% include 'todo/modal_append_task.html' %}
  {% endblock %}

  <div id='task-conteiner' class="container mt-3">
    <div class="accordion" id="accordionExample">

      <div id="accordion-header" class="accordion-item accordion-filter-buttons">
        {% block filter %}
          {% include 'todo/task_filter.html'%}
        {% endblock %}
      </div>

      {% for task in tasks %}
        <div id="accordion-item-{{task.id}}" 
          class="accordion-item task-state-{% if task.is_completed %}completed{% else %}uncompleted{% endif %}">
          <h2 class="accordion-header" id="headingOne">
            <button
              class="accordion-button {% if active_task != task.id %} not-collapsed-flag {% endif %} auto-collapsed-flag"
              type="button" 
              data-bs-toggle="collapse" 
              data-bs-target="#collapse{{task.id}}" 
              aria-expanded="true" 
              aria-controls="collapse{{task.id}}">
              
              <div class="{% if task.is_completed %} d-block {% else %} d-none {% endif %}" id="mark{{task.id}}"> 
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check2-square" viewBox="0 0 16 16">
                  <path d="M3 14.5A1.5 1.5 0 0 1 1.5 13V3A1.5 1.5 0 0 1 3 1.5h8a.5.5 0 0 1 0 1H3a.5.5 0 0 0-.5.5v10a.5.5 0 0 0 .5.5h10a.5.5 0 0 0 .5-.5V8a.5.5 0 0 1 1 0v5a1.5 1.5 0 0 1-1.5 1.5H3z"/>
                  <path d="M8.354 10.354l7-7a.5.5 0 0 0-.708-.708L8 9.293 5.354 6.646a.5.5 0 1  0-.708.708l3 3a.5.5 0 0 0 .708 0z"/>
                </svg>
              </div>      
              <span class="px-2">{{task.title}}</span>
            </button>
          </h2>
          <div id="collapse{{task.id}}" class="accordion-collapse auto-collapse-flag
            {% if active_task == task.id %} show {% endif %}" 
            aria-labelledby="headingOne" data-bs-parent="#accordionExample">
            <div class="accordion-body">{{task.text}}</div>

            <div id="comment-container-{{task.id}}">
              {% if task.comments %}
                {% for comment in task.comments.all reversed %}
                  <div id="comment-body-{{comment.id}}" class="accordion-body my-0 py-1">      
                    <div class="alert alert-secondary py-1 my-0" role="alert">
                      <div class="row g-3">
                        <!-- Кнопки для отправки ajax запросов -->
                        <a type="button" class="col-auto btn-close js_buttons d-none" 
                           onclick="make_delete_comment_requests('{% url "todo:api_delete_comment" %}', {{comment.id}})">
                        </a>
                      
                        <!-- Кнопка для работы по GET запросам -->
                        <a type="button" class="col-auto btn-close url_buttons d-flex" 
                            href="{% url 'todo:delete_comment' comment.id %}">
                        </a>

                        <div class="col-auto"><span>{{comment.text}}</span></div>
                        <div class="col-auto"></div>
                      </div> 
                    </div>
                  </div>
                {% endfor %}
              {% endif %}
            </div>
            <!-- Кнопки для отправки ajax запросов -->
            <div class=".container accordion-body js_buttons d-none">  

              <div id="complete-control-button{{task.id}}" class="{% if task.is_completed %} d-flex {% else %} d-none {% endif %}">
                <button type="button" class="me-1 btn btn-outline-warning"
                  onclick="make_change_task_status_requests('{% url "todo:api_set_uncompleted_status" %}', {{task.id}})">Снять отметку</button>
              </div>

              <div id="uncomplete-control-button{{task.id}}" class="{% if task.is_completed %} d-none {% else %} d-flex {% endif %}">
                <button type="button" class="me-1 btn btn-outline-primary"
                  onclick="make_change_task_status_requests('{% url "todo:api_set_completed_status" %}', {{task.id}})">Отметить как выполненая</button>        
              </div>

              <button type="button" class="me-1 btn btn-outline-secondary" data-bs-toggle="modal" 
                data-bs-target="#addComment" onclick="add_task_id_to_modal_form({{task.id}})">
                Добавить комментарий
              </button>
             
              <button type="button" class="me-1 btn btn-outline-danger" 
                onclick="make_delete_task_requests('{% url "todo:api_delete_task" %}', {{task.id}})">Удалить задачу</button>

                <a type="button" class="me-1 btn btn-outline-success"
                  href="{% url 'todo:update_task' task.id %}">Изменить</a>
            </div>

            <!-- Кнопки для работы по GET запросам -->
            <div class=".container accordion-body url_buttons d-flex">  
              {% if task.is_completed %}
                <a type="button" class="btn btn-outline-warning {% if task.is_completed %} d-flex {% else %} d-none {% endif %} me-1"
                  href="{% url 'todo:uncompleted' task.id %}">Снять отметку</a>
              {% else %}
                <a type="button" class="btn btn-outline-primary {% if task.is_completed %} d-none {% else %} d-flex {% endif %} me-1" 
                  href="{% url 'todo:completed' task.id %}">Отметить как выполненая</a>
              {% endif %}
              
              <a type="button" class="btn btn-outline-secondary me-1" 
                href="{% url 'todo:create_comment' %}?task_id={{task.id}}">Добавить комментарий</a>
              
              <a type="button" class="btn btn-outline-danger me-1" 
                href="{% url 'todo:delete_task' task.id %}">Удалить задачу</a>

              <a type="button" class="me-1 btn btn-outline-success"
                href="{% url 'todo:update_task' task.id %}">Изменить</a>

            </div>
          
          </div>
        </div>
      {% endfor %}

      <div id="accordion-item" class="accordion-item">
          <button class="btn accordion-add-button justify-content-center js_buttons d-none" data-bs-toggle="modal" data-bs-target="#addTask">
            <span>Добавить задачу</span>
          </button>

          <button class="btn accordion-add-button justify-content-center url_buttons">
            <a class="text-decoration-none" href="{% url 'todo:create_task' %}">Добавить задачу</a>
          </button>
      </div>
    </div>

    <div id="empty-tasks-alert" class="{% if tasks %} d-none {% else %} d-block {% endif %}">
      <div class="alert alert-secondary my-3 d-flex justify-content-center" role="alert"> У вас, пока-что, нет никаких задач. Добавьте задачу, чтобы не забыть о ней!</div>
    </div>

    {% load static %}
    <script src="{% static 'js/scripts.js'%}" type="text/javascript"></script>
  </div>
{% endblock %}